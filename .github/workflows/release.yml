name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # Check if tests already passed for this commit (or ancestor if only docs/release changes)
  check-tests:
    name: Check Prior Test Results
    runs-on: ubuntu-latest
    outputs:
      tests_passed: ${{ steps.check-api.outputs.tests_passed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 15  # Need ancestors for traversing past docs-only commits

      - name: Check for non-code changes
        id: check-files
        uses: ./.github/actions/check-file-changes
        with:
          # Files that don't require tests: release files + docs/config (matching test.yml)
          safe-patterns: '^(CHANGELOG\.md|package\.json|package-lock\.json|src-tauri/Cargo\.toml|src-tauri/Cargo\.lock|src-tauri/tauri\.conf\.json|.*\.md|_tasks/.*|\.claude/.*|\.github/.*|docs/.*)$'

      - name: Check if Tests workflow passed
        id: check-api
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          echo "Checking for Tests workflow results on commit: $COMMIT_SHA"

          # First: check if tests passed on this commit
          RESULT=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/test.yml/runs?head_sha=$COMMIT_SHA&status=success" \
            --jq '.total_count' 2>/dev/null || echo "0")

          if [ "$RESULT" -gt 0 ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
            echo "✅ Tests passed on this commit"
            exit 0
          fi

          echo "No test results on tagged commit - checking if release-only changes..."

          # Second: if only non-code files changed (release/docs), traverse ancestors
          if [ "${{ steps.check-files.outputs.has-code-changes }}" = "false" ]; then
            echo "✅ Only non-code files changed - searching ancestors for test results..."

            # Traverse up to 10 ancestors looking for successful tests
            CURRENT_SHA=$(git rev-parse HEAD)
            for i in $(seq 1 10); do
              ANCESTOR_SHA=$(git rev-parse HEAD~$i 2>/dev/null || break)
              echo "  Checking ancestor ~$i: $ANCESTOR_SHA"

              ANCESTOR_RESULT=$(gh api \
                -H "Accept: application/vnd.github+json" \
                "/repos/${{ github.repository }}/actions/workflows/test.yml/runs?head_sha=$ANCESTOR_SHA&status=success" \
                --jq '.total_count' 2>/dev/null || echo "0")

              if [ "$ANCESTOR_RESULT" -gt 0 ]; then
                echo "tests_passed=true" >> $GITHUB_OUTPUT
                echo "✅ Ancestor ~$i ($ANCESTOR_SHA) passed tests - skipping"
                exit 0
              fi
            done
            echo "⚠️ No ancestor with successful test run found (checked 10 commits)"
          else
            echo "❌ Code changes detected - cannot skip tests"
          fi

          echo "tests_passed=false" >> $GITHUB_OUTPUT
          echo "⚠️ No prior successful test run found - will run tests"

  # Run tests first - backend tests on all platforms (skip if already passed)
  backend-tests:
    name: Backend Tests (${{ matrix.platform }})
    needs: check-tests
    if: needs.check-tests.outputs.tests_passed != 'true'
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Run backend tests
        working-directory: src-tauri
        run: cargo test

  # Integration tests - build once, then run tiers in parallel (skip if already passed)
  integration-build:
    name: Integration Build
    needs: check-tests
    if: needs.check-tests.outputs.tests_passed != 'true'
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install npm dependencies
        run: npm ci

      - name: Build Tauri app (debug)
        run: npm run tauri build -- --debug --config src-tauri/tauri.conf.dev.json

      - name: Upload debug binary
        uses: actions/upload-artifact@v4
        with:
          name: debug-binary
          path: src-tauri/target/debug/kniha-jazd.exe
          retention-days: 1

  integration-tests:
    name: Integration Tests (${{ matrix.tier_name }})
    needs: [check-tests, integration-build]
    if: needs.check-tests.outputs.tests_passed != 'true'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - tier: '1'
            tier_name: 'Tier 1'
          - tier: '2'
            tier_name: 'Tier 2'
          - tier: '3'
            tier_name: 'Tier 3'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # Install Edge WebDriver matching WebView2 runtime version
      - name: Install Edge WebDriver
        shell: pwsh
        run: |
          # Tauri uses WebView2, not Edge browser - must match WebView2 version!
          $webview2Key = Get-ItemProperty -Path "HKLM:\SOFTWARE\WOW6432Node\Microsoft\EdgeUpdate\Clients\{F3017226-FE2A-4295-8BDF-00C3A9A7E4C5}" -ErrorAction SilentlyContinue
          if ($webview2Key -and $webview2Key.pv) {
            $webview2Version = $webview2Key.pv
          } else {
            $webview2Key = Get-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\EdgeUpdate\Clients\{F3017226-FE2A-4295-8BDF-00C3A9A7E4C5}" -ErrorAction SilentlyContinue
            $webview2Version = $webview2Key.pv
          }
          Write-Host "WebView2 runtime version: $webview2Version"
          $driverUrl = "https://msedgedriver.azureedge.net/$webview2Version/edgedriver_win64.zip"
          Write-Host "Downloading EdgeDriver from: $driverUrl"
          $maxRetries = 3
          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              Invoke-WebRequest -Uri $driverUrl -OutFile edgedriver.zip -TimeoutSec 60
              Write-Host "Download successful on attempt $i"
              break
            } catch {
              Write-Host "Attempt $i failed: $_"
              if ($i -eq $maxRetries) {
                $altUrl = "https://msedgewebdriverstorage.blob.core.windows.net/edgewebdriver/$webview2Version/edgedriver_win64.zip"
                Write-Host "Trying alternative URL: $altUrl"
                Invoke-WebRequest -Uri $altUrl -OutFile edgedriver.zip -TimeoutSec 60
              }
              Start-Sleep -Seconds 5
            }
          }
          Expand-Archive -Path edgedriver.zip -DestinationPath edgedriver -Force
          echo "$PWD\edgedriver" >> $env:GITHUB_PATH
          Write-Host "EdgeDriver $webview2Version installed successfully"

      - name: Install npm dependencies
        run: npm ci

      - name: Install tauri-driver
        run: cargo install tauri-driver

      - name: Download debug binary
        uses: actions/download-artifact@v4
        with:
          name: debug-binary
          path: src-tauri/target/debug

      - name: Run integration tests (${{ matrix.tier_name }})
        env:
          TAURI_BINARY: src-tauri/target/debug/kniha-jazd.exe
          TIER: ${{ matrix.tier }}
          PARALLEL_TIERS: 'true'
        run: npm run test:integration

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-screenshots-${{ matrix.tier_name }}
          path: tests/integration/screenshots/
          if-no-files-found: ignore

  # Build and release - only after all tests pass (or were skipped because already passed)
  build:
    needs: [check-tests, backend-tests, integration-tests]
    if: |
      always() && 
      (needs.check-tests.outputs.tests_passed == 'true' || 
       (needs.backend-tests.result == 'success' && needs.integration-tests.result == 'success'))
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            args: ''
          - platform: macos-latest
            args: '--target aarch64-apple-darwin'
          - platform: macos-latest
            args: '--target x86_64-apple-darwin'

    runs-on: ${{ matrix.platform }}
    env:
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Extract release notes from CHANGELOG
        id: changelog
        shell: bash
        run: |
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          NOTES=$(awk -v ver="$VERSION" '
            /^## \[/ { if (p) exit; if ($0 ~ "\\[" ver "\\]") p=1; next }
            p && /^### / { print $0; next }
            p { print $0 }
          ' CHANGELOG.md | head -c 1000)

          if [ -z "$NOTES" ]; then
            NOTES="Verzia $VERSION - podrobnosti v CHANGELOG.md"
          fi

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Kniha Jázd ${{ github.ref_name }}'
          releaseBody: ${{ steps.changelog.outputs.notes }}
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
