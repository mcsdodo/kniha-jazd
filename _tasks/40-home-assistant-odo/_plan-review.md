# Plan Review: Home Assistant ODO Integration

**Date:** 2026-01-27
**Reviewer:** Claude
**Plan:** `03-plan.md`

## Summary

The implementation plan is well-structured and follows project conventions. After 3 rounds of review, I identified issues that should be addressed before implementation.

---

## Round 1: Completeness Check

### Findings

**[Critical] Missing: Last trip ending ODO calculation**
- **Issue:** The plan says delta = realOdo - lastTripEndingOdo, but doesn't specify where `lastTripEndingOdo` comes from.
- **Impact:** Frontend cannot calculate delta without backend providing this value.
- **Fix:** Either:
  a) Add a backend command to return last trip's ending ODO (odometer + distanceKm from last trip), OR
  b) Calculate in frontend from trips data already available from `get_trip_grid_data`

**[Important] Missing: localStorage persistence detail**
- **Issue:** Step 3.2 mentions localStorage persistence but doesn't specify the key or migration strategy.
- **Fix:** Define localStorage key (e.g., `ha-odo-cache`) and handle missing/corrupt data gracefully.

**[Important] Missing: URL validation**
- **Issue:** No validation specified for HA URL format (must be valid URL with protocol).
- **Fix:** Add frontend validation before save (check `https://` prefix, valid URL format).

**[Minor] Missing: Token obfuscation in get_ha_settings**
- **Issue:** Step 1.4 says "returns url + whether token is set, NOT the token itself" but doesn't define the return struct.
- **Fix:** Define `HaSettings { url: Option<String>, hasToken: bool }` response type.

---

## Round 2: Feasibility Check

### Findings

**[Important] Phase ordering issue: Types should come BEFORE Phase 3**
- **Issue:** Phase 5 (TypeScript types) comes after Phase 3-4, but Phase 3 needs `HaOdoCache` and `HaSettings` types.
- **Fix:** Move Phase 5 to before Phase 3, or inline type definitions in Phase 3.

**[Important] Diesel schema update needs clarity**
- **Issue:** Step 1.2 says "Run diesel migration run" but doesn't mention updating `VehicleRow` struct.
- **Fix:** Step 1.3 should explicitly update:
  - `schema.rs` (auto-generated by Diesel)
  - `VehicleRow` struct in `models.rs`
  - `NewVehicleRow` struct in `models.rs`
  - `From<VehicleRow> for Vehicle` impl

**[Minor] Test Connection is "optional nice-to-have"**
- **Issue:** The task (01-task.md) doesn't require test connection, and it adds complexity.
- **Fix:** Keep it marked as optional, but consider removing to reduce scope.

---

## Round 3: Clarity Check

### Findings

**[Important] Vehicle modal file path uncertain**
- **Issue:** Step 2.3 says "VehicleModal.svelte (or similar)" - this is vague.
- **Confirmed:** The file is `src/lib/components/VehicleModal.svelte`.
- **Fix:** Update plan with exact path.

**[Important] Missing verification steps for Phase 1**
- **Issue:** No verification steps for backend changes before moving to frontend.
- **Fix:** Add verification:
  - Run `cargo test` after Step 1.1 (settings tests)
  - Run `diesel migration run` and verify schema.rs after Step 1.2
  - Run `cargo test` after Step 1.3 (vehicle CRUD tests)
  - Test commands via `npm run tauri dev` after Step 1.4

**[Important] No error handling spec for HA API**
- **Issue:** Step 3.1 says "Handle errors gracefully" but doesn't specify what errors to handle.
- **Fix:** Define error cases:
  - Network timeout (5s recommended)
  - Invalid credentials (401 response)
  - Sensor not found (404 or empty state)
  - Invalid response format (non-numeric state)

**[Minor] Staleness display format unclear**
- **Issue:** Design says "5m" or "5h" but doesn't specify threshold for switching to hours.
- **Fix:** Specify: use minutes for <60m, then hours (e.g., "59m" → "1h").

---

## Round 4: YAGNI Check

### Findings

**[Minor] Multi-vehicle cache may be premature**
- **Issue:** Step 3.2 defines `Map<vehicleId, HaOdoCache>` but the app typically shows one vehicle at a time.
- **Assessment:** Keep it - low cost, prevents bugs when switching vehicles.

**No scope creep detected** - All features align with 01-task.md requirements.

---

## Checklist Results

- [x] Tasks have specific file paths (except VehicleModal - now confirmed)
- [ ] Verification steps for each phase (missing for Phase 1)
- [ ] Correct implementation order (Phase 5 should precede Phase 3)
- [x] No scope creep beyond 01-task.md requirements

---

## Recommended Changes

### Critical (Must Fix)

1. **Add backend support for lastTripEndingOdo**
   - Option A: Add new command `get_last_trip_ending_odo(vehicle_id, year)` → returns `Option<f64>`
   - Option B (preferred): Calculate in frontend from `trips` array (last trip's `odometer` value is already the ending ODO)

### Important (Should Fix)

2. **Reorder phases:** Move Phase 5 (Types) before Phase 3
3. **Add Phase 1 verification steps** after each step
4. **Clarify Step 1.3:** List all files that need updating (models.rs structs, From impl)
5. **Specify VehicleModal path:** `src/lib/components/VehicleModal.svelte`
6. **Add URL validation** in Step 2.2
7. **Define error handling** for HA API calls in Step 3.1

### Minor (Nice to Have)

8. Define localStorage key and format
9. Specify staleness display threshold (minutes → hours)
10. Define `HaSettings` response type explicitly

---

## Verdict

**Plan is APPROVED with amendments.** The critical issue (delta calculation) has a simple solution: the frontend already has trips data, so `lastTripEndingOdo` = last trip's `odometer` field (which already represents ending ODO per the app's convention). The important issues are mostly documentation gaps that can be addressed during implementation.

**Recommended approach:** Fix the phase ordering and add verification steps, then proceed with implementation.

---

## Resolution (2026-01-27)

**Addressed (Critical + Important):**
- [x] Delta calculation clarified - uses last trip's `odometer` field (Step 4.2)
- [x] Phase ordering fixed - Types moved to Phase 2 before Service/Store
- [x] Phase 1 verification steps added to all steps
- [x] Step 1.3 clarified - lists VehicleRow, NewVehicleRow, From impl
- [x] VehicleModal path specified - `src/lib/components/VehicleModal.svelte`
- [x] URL validation added to Step 2.3
- [x] Error handling defined in Step 3.1 (timeout, 401, 404, invalid response)

**Skipped (Minor):**
- [ ] localStorage key - specified as `kniha-jazd-ha-odo-cache` (actually addressed)
- [ ] Staleness threshold - specified in Step 4.3 (<60m = minutes, >=60m = hours)
- [ ] HaSettings response type - defined in Step 2.1

**Result:** All findings addressed. Plan ready for implementation.
