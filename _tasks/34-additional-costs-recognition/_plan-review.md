# Plan Review

**Target:** `_tasks/34-additional-costs-recognition/`
**Started:** 2026-01-12
**Status:** Ready for User Review
**Focus:** Completeness, feasibility, clarity

---

## Review Summary

**Iterations:** 1
**Total Findings:** 3 Critical, 5 Important, 5 Minor

### Verdict: NEEDS REVISION

The plan demonstrates good understanding of the existing architecture but has several gaps that would cause implementation friction or runtime errors. Resolution of the critical items is mandatory before proceeding.

---

## All Findings (Consolidated)

### Critical

1. [ ] **Unresolved open questions block implementation**
   - Location: `02-design.md` lines 287-299, `03-plan.md` lines 7-8
   - Three design decisions are unresolved: multiple costs per trip, category list type, folder configuration
   - **Must be resolved with `/decision` BEFORE implementation**

2. [ ] **Assignment collision not handled**
   - Location: `02-design.md` lines 183-186, `03-plan.md` lines 147-152
   - What happens when user assigns a second cost invoice to a trip that already has `other_costs_eur`?
   - Options: overwrite, sum, reject, support multiple (requires Trip model change)

3. [ ] **Diesel migration file naming convention wrong**
   - Location: `03-plan.md` lines 43-49
   - Plan shows: `YYYYMMDD_add_receipt_type.sql`
   - Should be: `YYYY-MM-DD-HHMMSS-add_receipt_type/up.sql` + `down.sql`

### Important

1. [ ] **Gemini prompt backward compatibility risk**
   - Location: `02-design.md` lines 98-139
   - New prompt changes response schema; must make new fields optional
   - Default `receipt_type` to `Fuel` if not present for backward compatibility

2. [ ] **Missing ReceiptRow and NewReceiptRow update details**
   - Location: `03-plan.md` Step 1.5
   - Plan doesn't mention: `From<ReceiptRow>` implementation, `receipt_type_to_str()` method
   - These structs are in `models.rs`, not `db.rs`

3. [ ] **FieldConfidence struct needs extension**
   - Location: Not addressed in plan
   - Current struct has `liters`, `total_price`, `date` - meaningless for non-fuel
   - Need to add `cost_amount: ConfidenceLevel` or document field reuse

4. [ ] **ReceiptCard component may not exist**
   - Location: `03-plan.md` Step 4.2
   - Plan references `ReceiptCard.svelte` but receipts UI is inline in `doklady/+page.svelte`
   - Verify if component exists or add task to create it

5. [ ] **Schema.rs auto-generation not noted**
   - Location: `03-plan.md` Step 1.4
   - `schema.rs` is auto-generated by Diesel CLI; plan should note this
   - Change to: "Run `diesel migration run` to auto-update schema.rs"

### Minor

1. [ ] **Inconsistent type naming between Rust/JSON/DB**
   - Rust: `CarWash`, JSON: `"car_wash"`, DB: unclear
   - Document explicit mapping

2. [ ] **Icon choices may not render correctly**
   - Emoji icons (üöø, üÖøÔ∏è) may not render consistently
   - Verify current icon approach in codebase

3. [ ] **Missing test file references**
   - Plan doesn't specify where tests should be added
   - Should reference: `receipts_tests.rs`, `gemini.rs` test module, `db_tests.rs`

4. [ ] **i18n keys not specified**
   - Plan says "add translations" but doesn't list specific keys
   - Should list: `receipts.types.fuel`, `receipts.types.carWash`, etc.

5. [ ] **Integration test tier not specified**
   - New tests should be in Tier 1 for PR feedback per CLAUDE.md

---

## Completeness Assessment

| Requirement | Addressed | Notes |
|-------------|-----------|-------|
| Folder-based input | ‚úÖ Yes | Same folder with AI classification |
| Automatic recognition | ‚úÖ Yes | Extended Gemini prompt |
| Extract key fields | ‚ö†Ô∏è Partial | Missing confidence for new fields |
| Assignment to trips | ‚ö†Ô∏è Partial | Collision handling missing |
| Management UI | ‚úÖ Yes | Filter by type, visual distinction |
| Reuse infrastructure | ‚úÖ Yes | Extends existing Receipt model |
| Consistent UX | ‚úÖ Yes | Same workflow as fuel |
| Distinguish from fuel | ‚úÖ Yes | Icons, colors, filters |

---

## Recommendation

**Before proceeding:**
1. Resolve open questions with `/decision` (Critical #1)
2. Add collision handling logic to plan (Critical #2)
3. Fix migration file naming (Critical #3)

**Estimated additional effort:** 2-3 hours for plan revisions
